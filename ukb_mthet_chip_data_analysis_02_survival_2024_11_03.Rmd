---
title: "UKB - Heteroplasmy, CHIP, and MN"
subtitle: "02 - survival analysis for heteroplasmy or CHIP: Figure 4, Supplementary Table 3, Supplementary Figures 5-8, Supplementary Figure 10"  
author: "Yun Soo Hong, Sergiu Pasca"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: false 
      smooth_scroll: false 
    pandoc_args: [
    "--number-sections",
    "--number-offset=0"
    ]
fontsize: 11pt              
---

# Set up  

## Program description  
* This program reads in the cleaned data set (`ukb_mthet_chip_dp3_2024_03_13.rds`), performs analysis in the "Mitochondrial heteroplasmy improves risk prediction for myeloid neoplasms" paper (Nature Communications, 2024), and provided the data used for generating tables and figures.   
* This file contains
  -   Figure 4, Supplementary Table 3, Supplementary Figures 5-8, Supplementary Figure 10.    

* Steps  
  * Step 1: Read in data  
  * Step 2: Settings    
  * Step 3: Figure 4  
  * Step 4: Supplementary Table 3  
  * Step 5: Supplementary Figure 5  
  * Step 6: Supplementary Figure 6  
  * Step 7: Supplementary Figure 7  
  * Step 8: Supplementary Figure 8  
  * Step 9: Supplementary Figure 10

## Version of R and packages  

```{r analysis set up, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries  

```{r analysis load libraries, echo = TRUE, message = FALSE}
library(tidyverse)
library(magrittr)
library(lubridate)
library(stringr)
library(data.table)
library(survival)
library(survminer)
```

## Print out settings  

```{r analysis print settings}
options(tibble.print_max = 100)
options(pillar.sigfig = 5)
```

# Load data  

```{r analysis load data, include = FALSE}
ukb <- 
  readRDS("../data_cleaning/ukb_mthet_chip_dp3_2024_03_13.rds")
```

# Settings   

## Excel output  

```{r analysis excel output}
wb <- openxlsx::createWorkbook("")

# Add some sheets to the workbook
openxlsx::addWorksheet(wb, "Supplementary Table 3")
openxlsx::addWorksheet(wb, "Supplementary Figure 5")
openxlsx::addWorksheet(wb, "Supplementary Figure 6")
openxlsx::addWorksheet(wb, "Supplementary Figure 7")
openxlsx::addWorksheet(wb, "Supplementary Figure 8")
```

## Survival analysis    

### Time to event      

```{r analysis tte}
summary(ukb$cancer_date_blood_mn)

# all participants  
ukb <-
  ukb |>
  mutate(
    time = as.numeric((cancer_date_blood_mn - dov)/365.25),
    end_date = case_when(
      # those who develop MN before death   
      cancer_dx_blood_mn == 1 & 
        (cancer_date_blood_mn <= date_of_death) ~ cancer_date_blood_mn, 
      # those who die without developing MN
      death == 1 & 
        (date_of_death < cancer_date_blood_mn) ~ date_of_death, 
      # otherwise, administrative censoring  
      TRUE ~ as.Date("2022-12-20")
    ), 
    tt = as.numeric(end_date - dov)/365.25
  )
summary(ukb$tt)

# CHIP positive  
ukb_chip <- 
  ukb |>
  filter(chip_yn == 1) |>
  mutate(
    chrs_cat = droplevels(chrs_cat)
  )

# CHIP negative  
ukb_nochip <- 
  ukb |>
  filter(chip_yn == 0)

# Heteroplasmy positive    
ukb_het <-
  ukb |>
  filter(het_yn == 1) |>
  mutate(
    count_het_cat = droplevels(count_het_cat)
  )

# Heteroplasmy positive, CHIP positive    
ukb_chip_het <-
  ukb_chip |>
  filter(het_yn == 1) |>
  mutate(
    count_het_cat = droplevels(count_het_cat)
  )

# Heteroplasmy positive, CHIP negative    
ukb_nochip_het <-
  ukb_nochip |>
  filter(het_yn == 1) |>
  mutate(
    count_het_cat = droplevels(count_het_cat)
  )
```

### Survival object        

```{r analysis obj}
surv <-
  with(ukb, Surv(time = tt, event = cancer_dx_blood_mn))

surv_chip <-
  with(ukb_chip, Surv(time = tt, event = cancer_dx_blood_mn))

surv_nochip <-
  with(ukb_nochip, Surv(time = tt, event = cancer_dx_blood_mn))

surv_het <-
  with(ukb_het, Surv(time = tt, event = cancer_dx_blood_mn)) 

surv_chip_het <-
  with(ukb_chip_het, Surv(time = tt, event = cancer_dx_blood_mn))

surv_nochip_het <-
  with(ukb_nochip_het, Surv(time = tt, event = cancer_dx_blood_mn))
```

# Figure 4 - Risk of MN incidence based on CHIP and heteroplasmy status.  

## Panel A  

### KM curve    

```{r analysis figure 4 km a}
km <- survfit(surv ~ het_yn, data = ukb)

survminer::ggsurvplot(
  km, 
  censor = FALSE,
  risk.table = TRUE, 
  risk.table.y.text = F, 
  risk.table.y.text.col = T,
  risk.table.title = "",
  fontsize = 4,
  risk.table.col = "strata",
  risk.table.height = 0.3,
  tables.theme = theme_cleantable(), 
  fun = "event", 
  xlim = c(0, 15), 
  ylim = c(0, 0.005),
  break.time.by = 5, 
  surv.scale = "percent", 
  legend.title = "", 
  legend.lab = c("No heteroplasmy", "Heteroplasmy"),
  xlab = "Time since study enrollment (years)",
  ylab = "Cumulative incidence",
  palette = c("#595959FF", "#00A087FF")
)
```

### Hazard ratios  

```{r analysis figure 4 hr a}
survival::coxph(surv ~ het_yn + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb) |>
  summary()
```

## Panel C     

### KM curve    

```{r analysis figure 4 km c}
km <- survfit(surv ~ het_chip, data = ukb)

survminer::ggsurvplot(
  km, 
  censor = FALSE,
  risk.table = TRUE, 
  risk.table.y.text = F, 
  risk.table.y.text.col = T,
  risk.table.title = "",
  fontsize = 4,
  risk.table.col = "strata",  
  risk.table.height = 0.3,
  tables.theme = theme_cleantable(),
  fun = "event", 
  xlim = c(0, 15), 
  ylim = c(0, 0.024),
  surv.scale = "percent",   
  break.time.by = 5, 
  legend.title = "", 
  legend.lab = c("None", "Heteroplasmy only", "CHIP only", "Both"),
  xlab = "Time since study enrollment (years)",
  ylab = "Cumulative incidence",
  palette = c("#595959FF", "#00A087FF", "#4DBBD5FF", "#E64835FF")
)
```

### Hazard ratios  

```{r analysis figure 4 hr c}
survival::coxph(surv ~ het_chip + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb) |>
  summary()
```

# Supplementary Table 3 - Sensitivity analyses for the associations of heteroplasmy, CHIP, and MN.      

## Restricted to self-reported White individuals  

```{r analysis suppl table 3 col1}
# Number of participants  
ukb |>
  filter(race_new == "white") |>
  summarise(participants = n())

# Heteroplasmy vs. CHIP  
m1 <- survival::coxph(surv ~ het_chip + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb, subset = race_new == "white") 
summary(m1)

m1_table_w <- 
  summary(m1)$coefficients[c(1:3), c(1:3, 5)] |>
  as.data.frame() |>
  mutate(character = "white") |>
  rownames_to_column("variable")

# Heteroplasmy metrics  
m2 <- survival::coxph(surv ~ count_het + mMSS + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb, subset = race_new == "white") 
summary(m2)

m2_table_w <- 
  summary(m2)$coefficients[c(1:2), c(1:3, 5)] |>
  as.data.frame() |>
  mutate(character = "white") |>
  rownames_to_column("variable")

# CHRS category  
ukb_chip |>
  filter(race_new == "white") |>
  summarise(participants = n())
m3 <- survival::coxph(surv_chip ~ chrs_cat + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb_chip, subset = race_new == "white")  
summary(m3)

m3_table_w <- 
  summary(m3)$coefficients[c(1:2), c(1:3, 5)] |>
  as.data.frame() |>
  mutate(character = "white") |>
  rownames_to_column("variable")
```

## Restricted to self-reported non-White individuals  

```{r analysis suppl table 3 col2}
# Number of participants  
ukb |>
  filter(race_new != "white") |>
  summarise(participants = n())

# Heteroplasmy vs. CHIP  
m1 <- survival::coxph(surv ~ het_chip + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb, subset = race_new != "white") 
summary(m1)

m1_table_nw <- 
  summary(m1)$coefficients[c(1:3), c(1:3, 5)] |>
  as.data.frame() |>
  mutate(character = "non-white") |>
  rownames_to_column("variable")

# Heteroplasmy metrics  
m2 <- survival::coxph(surv ~ count_het + mMSS + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb, subset = race_new != "white") 
summary(m2)

m2_table_nw <- 
  summary(m2)$coefficients[c(1:2), c(1:3, 5)] |>
  as.data.frame() |>
  mutate(character = "non-white") |>
  rownames_to_column("variable")

# CHRS category  
ukb_chip |>
  filter(race_new != "white") |>
  summarise(participants = n())
m3 <- survival::coxph(surv_chip ~ chrs_cat + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb_chip, subset = race_new != "white")
summary(m3)

m3_table_nw <- 
  summary(m3)$coefficients[c(1:2), c(1:3, 5)] |>
  as.data.frame() |>
  mutate(character = "non-white") |>
  rownames_to_column("variable")
```

## Restricted to genetically unrelated individuals    

```{r analysis suppl table 3 col3}
# Number of participants  
ukb |>
  filter(unrelated == 1) |>
  summarise(participants = n())

# Heteroplasmy vs. CHIP  
m1 <- survival::coxph(surv ~ het_chip + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb, subset = unrelated == 1)
summary(m1)

m1_table_unrel <- 
  summary(m1)$coefficients[c(1:3), c(1:3, 5)] |>
  as.data.frame() |>
  mutate(character = "unrelated") |>
  rownames_to_column("variable")

# Heteroplasmy metrics  
m2 <- survival::coxph(surv ~ count_het + mMSS + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb, subset = unrelated == 1)
summary(m2)

m2_table_unrel <- 
  summary(m2)$coefficients[c(1:2), c(1:3, 5)] |>
  as.data.frame() |>
  mutate(character = "unrelated") |>
  rownames_to_column("variable")

# CHRS category  
ukb_chip |>
  filter(unrelated == 1) |>
  summarise(participants = n())
m3 <- survival::coxph(surv_chip ~ chrs_cat + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb_chip, subset = unrelated == 1) 
summary(m3)

m3_table_unrel <- 
  summary(m3)$coefficients[c(1:2), c(1:3, 5)] |>
  as.data.frame() |>
  mutate(character = "unrelated") |>
  rownames_to_column("variable")
```

## Restricted to never smokers    

```{r analysis suppl table 3 col4}
# Number of participants  
ukb |>
  filter(smk == "never") |>
  summarise(participants = n())

# Heteroplasmy vs. CHIP  
m1 <- survival::coxph(surv ~ het_chip + rms::rcs(age, 5) + sex + prev_cancer_yn, data = ukb, subset = smk == "never")
summary(m1)

m1_table_ns <- 
  summary(m1)$coefficients[c(1:3), c(1:3, 5)] |>
  as.data.frame() |>
  mutate(character = "never smoker") |>
  rownames_to_column("variable")

# Heteroplasmy metrics  
m2 <- survival::coxph(surv ~ count_het + mMSS + rms::rcs(age, 5) + sex + prev_cancer_yn, data = ukb, subset = smk == "never")
summary(m2)

m2_table_ns <- 
  summary(m2)$coefficients[c(1:2), c(1:3, 5)] |>
  as.data.frame() |>
  mutate(character = "never_smoker") |>
  rownames_to_column("variable")

# CHRS category  
ukb_chip |>
  filter(smk == "never") |>
  summarise(participants = n())
m3 <- survival::coxph(surv_chip ~ chrs_cat + rms::rcs(age, 5) + sex + prev_cancer_yn, data = ukb_chip, subset = smk == "never")
summary(m3)

m3_table_ns <- 
  summary(m3)$coefficients[c(1:2), c(1:3, 5)] |>
  as.data.frame() |>
  mutate(character = "never smoker") |>
  rownames_to_column("variable")
```

## Restricted to individuals without prevalent cancer.      

```{r analysis suppl table 3 col5}
# Number of participants  
ukb |>
  filter(prev_cancer_yn == 0) |>
  summarise(participants = n())

# Heteroplasmy vs. CHIP  
m1 <- survival::coxph(surv ~ het_chip + rms::rcs(age, 5) + sex + smk_ever, data = ukb, subset = prev_cancer_yn == 0)
summary(m1)

m1_table_cancer <- 
  summary(m1)$coefficients[c(1:3), c(1:3, 5)] |>
  as.data.frame() |>
  mutate(character = "no cancer") |>
  rownames_to_column("variable")

# Heteroplasmy metrics  
m2 <- survival::coxph(surv ~ count_het + mMSS + rms::rcs(age, 5) + sex + smk_ever, data = ukb, subset = prev_cancer_yn == 0)
summary(m2)

m2_table_cancer <- 
  summary(m2)$coefficients[c(1:2), c(1:3, 5)] |>
  as.data.frame() |>
  mutate(character = "no cancer") |>
  rownames_to_column("variable")

# CHRS category  
ukb_chip |>
  filter(prev_cancer_yn == 0) |>
  summarise(participants = n())
m3 <- survival::coxph(surv_chip ~ chrs_cat + rms::rcs(age, 5) + sex + smk_ever, data = ukb_chip, subset = prev_cancer_yn == 0)
summary(m3)

m3_table_cancer <- 
  summary(m3)$coefficients[c(1:2), c(1:3, 5)] |>
  as.data.frame() |>
  mutate(character = "no cancer") |>
  rownames_to_column("variable")
```

## combine results  

```{r analysis suppl table 3}
table_w <- 
  m1_table_w |>
  bind_rows(
    m2_table_w, m3_table_w
  )

table_nw <- 
  m1_table_nw |>
  bind_rows(
    m2_table_nw, m3_table_nw
  )

table_unrel <- 
  m1_table_unrel |>
  bind_rows(
    m2_table_unrel, m3_table_unrel
  )

table_ns <- 
  m1_table_ns |>
  bind_rows(
    m2_table_ns, m3_table_ns
  )

table_cancer <- 
  m1_table_cancer |>
  bind_rows(
    m2_table_cancer, m3_table_cancer
  )

table_sp3 <- 
  bind_rows(
    table_w, table_nw, table_unrel, table_ns, table_cancer
  ) |>
  dplyr::select(character, everything())

# Write the data to the sheets
openxlsx::writeData(wb, sheet = "Supplementary Table 3", x = table_sp3)
```

# Supplementary Figure 5 - Hazard ratios (95% confidence intervals) for the association between heteroplasmy and incident MN.  

## Panel A  

```{r analysis suppl figure 5 a}
# Heteroplasmy count in categories
hc_cat <- 
  survival::coxph(surv ~ count_het_cat + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb) 
summary(hc_cat)

hc_cat_table <- 
  table(ukb$count_het_cat, ukb$cancer_dx_blood_mn, useNA = "ifany") |>
  unclass() |>
  as.data.frame() |>
  rename(
    control = `0`,
    case = `1` 
  ) |>
  mutate(
    total = control + case
  )
hc_cat_table

coef_hc_cat <- summary(hc_cat)$coef[1:4, c(1:3, 5)]
coef_hc_cat

# Heteroplasmy count as continuous
hc <- 
  survival::coxph(surv ~ count_het + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb) 
summary(hc)

hc_table <- 
  table(ukb$cancer_dx_blood_mn, useNA = "ifany") |>
  as.data.frame() |> 
  spread(Var1, Freq) |>
  rename(
    control = `0`, 
    case = `1`
  ) |>
  mutate(
    total = control + case
  )
hc_table 

coef_hc <- summary(hc)$coef[1, c(1:3, 5)]
coef_hc

# mMSS
mss <- 
  survival::coxph(surv ~ mMSS + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb) 
summary(mss)

mss_table <- 
  table(ukb$cancer_dx_blood_mn, useNA = "ifany") |>
  as.data.frame() |> 
  spread(Var1, Freq) |>
  rename(
    control = `0`, 
    case = `1`
  ) |>
  mutate(
    total = control + case
  )
mss_table  

coef_mss <- summary(mss)$coef[1, c(1:3, 5)]
coef_mss

coef <- 
  rbind(coef_hc_cat, coef_hc, coef_mss) |>
  as_tibble() |>
  mutate(
    var = c("hc1", "hc2", "hc3", "hc4", "hc", "mss")
  ) |>
  rename(
    exp_coef = `exp(coef)`,
    se_coef = `se(coef)`
  ) |>
  dplyr::select(var, everything())
coef

# data transformation for forest plot   
coef_all <- coef |>
  # add additional rows for categorical variables (1 for group name, 1 for reference) and 1 additional row for continuous variable (1 for group name)
  mutate(
    row = c(3:6, 8, 10)
  ) |>
  add_row(
    row = c(1:2, 7, 9)
  ) |>
  arrange(row) |>
  # add a column for group and category  
  mutate(
    Variable = 
      c("Heteroplasmy count", "", "", "", "", "", "Heteroplasmy count", "", "mMSS", ""),
    Categories = 
      c("", "0", "1", "2", "3", "4+", "", "Continuous", "", "Continuous")
  )  %>%
  # tidy the estimates  
  mutate(
    lci =
      ifelse(row == 1 | row == 2 | row == 7 | row == 9, 1, exp(coef - 1.96*se_coef)),
    uci =
      ifelse(row == 1 | row == 2 | row == 7 | row == 9, 1, exp(coef + 1.96*se_coef)),
    ` ` = paste(rep(" ", 25), collapse = " "),
    `Adjusted HR (95% CI)` = sprintf("%.2f (%.2f to %.2f)", exp_coef, lci, uci),
    `Adjusted HR (95% CI)` = case_when(
      row == 2 ~ "Reference",
      row == 1 | row == 7 | row == 9 ~ "",
      TRUE ~ `Adjusted HR (95% CI)`)
    ) |>
  dplyr::select(
    Variable, Categories, exp_coef, lci, uci, ` `, `Adjusted HR (95% CI)`, `Pr(>|z|)`, row
  )

coef_all

table <- 
  rbind(hc_cat_table, hc_table, mss_table) |>
  as_tibble() |>
  mutate(
    row = c(2:6, 8, 10)
  ) %>%
  add_row(
    row = c(1, 7, 9)
  ) %>%
  arrange(row)
table

data_all <- 
  coef_all |>
  left_join(table, by = "row") |>
  mutate(
    total = as.character(total), 
    total = case_when(
      row == 1 | row == 7 | row == 9 ~ "",
      TRUE ~ total
    ),
    case = as.character(case),
    case = case_when(
      row == 1 | row == 7 | row == 9 ~ "",
      TRUE ~ case
    ) 
  ) |>
  rename(
    Total = total,
    Events = case
  ) |>
  dplyr::select(
    Variable, Categories, Total, Events, ` `, `Adjusted HR (95% CI)`, exp_coef, lci, uci, `Pr(>|z|)` 
  )
data_all

p_hc_mss_all <- 
  forestploter::forest(
  data_all[, c(1:6)],
  est = data_all$exp_coef,
  lower = data_all$lci, 
  upper = data_all$uci, 
  ci_column = 5, 
  ref_line = 1,
  x_trans = "log",
  xlim = c(1, 9), 
  ticks_at = c(1, 3, 6, 9)
  )
```

## Panel B  

```{r analysis suppl figure 5 b}
# Heteroplasmy count in categories
hc_cat <- 
  survival::coxph(surv_het ~ count_het_cat + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb_het) 
summary(hc_cat)

hc_cat_table <- 
  table(ukb_het$count_het_cat, ukb_het$cancer_dx_blood_mn, useNA = "ifany") |>
  unclass() |>
  as.data.frame() |>
  rename(
    control = `0`,
    case = `1` 
  ) |>
  mutate(
    total = control + case
  )
hc_cat_table

coef_hc_cat <- summary(hc_cat)$coef[1:3, c(1:3, 5)]
coef_hc_cat

# Heteroplasmy count as continuous
hc <- 
  survival::coxph(surv_het ~ count_het + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb_het) 
summary(hc)

hc_table <- 
  table(ukb_het$cancer_dx_blood_mn, useNA = "ifany") |>
  as.data.frame() |> 
  spread(Var1, Freq) |>
  rename(
    control = `0`, 
    case = `1`
  ) |>
  mutate(
    total = control + case
  )
hc_table 

coef_hc <- summary(hc)$coef[1, c(1:3, 5)]
coef_hc

# mMSS
mss <- 
  survival::coxph(surv_het ~ mMSS + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb_het) 
summary(mss)

mss_table <- 
  table(ukb_het$cancer_dx_blood_mn, useNA = "ifany") |>
  as.data.frame() |> 
  spread(Var1, Freq) |>
  rename(
    control = `0`, 
    case = `1`
  ) |>
  mutate(
    total = control + case
  )
mss_table  

coef_mss <- summary(mss)$coef[1, c(1:3, 5)]
coef_mss

coef <- 
  rbind(coef_hc_cat, coef_hc, coef_mss) |>
  as_tibble() |>
  mutate(
    var = c("hc2", "hc3", "hc4", "hc", "mss")
  ) |>
  rename(
    exp_coef = `exp(coef)`,
    se_coef = `se(coef)`
  ) |>
  dplyr::select(var, everything())
coef

# data transformation for forest plot   
coef_all <- coef |>
  # add additional rows for categorical variables (1 for group name, 1 for reference) and 1 additional row for continuous variable (1 for group name)
  mutate(
    row = c(3:5, 7, 9)
  ) |>
  add_row(
    row = c(1:2, 6, 8)
  ) |>
  arrange(row) |>
  # add a column for group and category  
  mutate(
    Variable = 
      c("Heteroplasmy count", "", "", "", "", "Heteroplasmy count", "", "mMSS", ""),
    Categories = 
      c("", "1", "2", "3", "4+", "", "Continuous", "", "Continuous")
  )  %>%
  # tidy the estimates  
  mutate(
    lci =
      ifelse(row == 1 | row == 2 | row == 6 | row == 8, 1, exp(coef - 1.96*se_coef)),
    uci =
      ifelse(row == 1 | row == 2 | row == 6 | row == 8, 1, exp(coef + 1.96*se_coef)),
    ` ` = paste(rep(" ", 25), collapse = " "),
    `Adjusted HR (95% CI)` = sprintf("%.2f (%.2f to %.2f)", exp_coef, lci, uci),
    `Adjusted HR (95% CI)` = case_when(
      row == 2 ~ "Reference",
      row == 1 | row == 6 | row == 8 ~ "",
      TRUE ~ `Adjusted HR (95% CI)`)
    ) |>
  dplyr::select(
    Variable, Categories, exp_coef, lci, uci, ` `, `Adjusted HR (95% CI)`, `Pr(>|z|)`, row
  )

coef_all

table <- 
  rbind(hc_cat_table, hc_table, mss_table) |>
  as_tibble() |>
  mutate(
    row = c(2:5, 7, 9)
  ) %>%
  add_row(
    row = c(1, 6, 8)
  ) %>%
  arrange(row)
table

data_het <- 
  coef_all |>
  left_join(table, by = "row") |>
  mutate(
    total = as.character(total), 
    total = case_when(
      row == 1 | row == 6 | row == 8 ~ "",
      TRUE ~ total
    ),
    case = as.character(case),
    case = case_when(
      row == 1 | row == 6 | row == 8 ~ "",
      TRUE ~ case
    ) 
  ) |>
  rename(
    Total = total,
    Events = case
  ) |>
  dplyr::select(
    Variable, Categories, Total, Events, ` `, `Adjusted HR (95% CI)`, exp_coef, lci, uci, `Pr(>|z|)` 
  )
data_het

p_hc_mss_het <- 
  forestploter::forest(
  data_het[, c(1:6)],
  est = data_het$exp_coef,
  lower = data_het$lci, 
  upper = data_het$uci, 
  ci_column = 5, 
  ref_line = 1,
  x_trans = "log",
  xlim = c(1, 9), 
  ticks_at = c(1, 3, 6, 9)
  )
```

## Combined  

```{r analysis suppl figure 5, fig.height = 7, fig.width = 10}
combined <- ggpubr::ggarrange(p_hc_mss_all, p_hc_mss_het, labels = c("A", "B"), nrow = 2, ncol = 1, align = "v")
combined

data <-
  data_all |>
  bind_rows(data_het) |>
  add_row(.before = 1) |>
  add_row(.before = 12) |>
  mutate(
    Panel = c("A", "", "", "", "", "", "", "", "", "", "", "B", "", "", "", "", "", "", "", "", "")
  ) |>
  dplyr::select(Panel, everything())

# Write the data to the sheets
openxlsx::writeData(wb, sheet = "Supplementary Figure 5", x = data)

# data |> 
#   openxlsx::write.xlsx("ukb_mthet_chip_source_data_file.xlsx", sheetName = "Supplementary Figure 5")
```

# Supplementary Figure 6 - Hazard ratios (95% confidence intervals) for the association between heteroplasmy and incident MN in individuals with CHIP.  

## Panel A  

```{r analysis suppl figure 6 a}
# Heteroplasmy count in categories
hc_cat <- 
  survival::coxph(surv_chip ~ count_het_cat + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb_chip) 
summary(hc_cat)

hc_cat_table <- 
  table(ukb_chip$count_het_cat, ukb_chip$cancer_dx_blood_mn, useNA = "ifany") |>
  unclass() |>
  as.data.frame() |>
  rename(
    control = `0`,
    case = `1` 
  ) |>
  mutate(
    total = control + case
  )
hc_cat_table

coef_hc_cat <- summary(hc_cat)$coef[1:4, c(1:3, 5)]
coef_hc_cat

# Heteroplasmy count as continuous
hc <- 
  survival::coxph(surv_chip ~ count_het + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb_chip) 
summary(hc)

hc_table <- 
  table(ukb_chip$cancer_dx_blood_mn, useNA = "ifany") |>
  as.data.frame() |> 
  spread(Var1, Freq) |>
  rename(
    control = `0`, 
    case = `1`
  ) |>
  mutate(
    total = control + case
  )
hc_table 

coef_hc <- summary(hc)$coef[1, c(1:3, 5)]
coef_hc

# mMSS
mss <- 
  survival::coxph(surv_chip ~ mMSS + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb_chip) 
summary(mss)

mss_table <- 
  table(ukb_chip$cancer_dx_blood_mn, useNA = "ifany") |>
  as.data.frame() |> 
  spread(Var1, Freq) |>
  rename(
    control = `0`, 
    case = `1`
  ) |>
  mutate(
    total = control + case
  )
mss_table  

coef_mss <- summary(mss)$coef[1, c(1:3, 5)]
coef_mss

coef <- 
  rbind(coef_hc_cat, coef_hc, coef_mss) |>
  as_tibble() |>
  mutate(
    var = c("hc1", "hc2", "hc3", "hc4", "hc", "mss")
  ) |>
  rename(
    exp_coef = `exp(coef)`,
    se_coef = `se(coef)`
  ) |>
  dplyr::select(var, everything())
coef

# data transformation for forest plot   
coef_all <- coef |>
  # add additional rows for categorical variables (1 for group name, 1 for reference) and 1 additional row for continuous variable (1 for group name)
  mutate(
    row = c(3:6, 8, 10)
  ) |>
  add_row(
    row = c(1:2, 7, 9)
  ) |>
  arrange(row) |>
  # add a column for group and category  
  mutate(
    Variable = 
      c("Heteroplasmy count", "", "", "", "", "", "Heteroplasmy count", "", "mMSS", ""),
    Categories = 
      c("", "0", "1", "2", "3", "4+", "", "Continuous", "", "Continuous")
  )  %>%
  # tidy the estimates  
  mutate(
    lci =
      ifelse(row == 1 | row == 2 | row == 7 | row == 9, 1, exp(coef - 1.96*se_coef)),
    uci =
      ifelse(row == 1 | row == 2 | row == 7 | row == 9, 1, exp(coef + 1.96*se_coef)),
    ` ` = paste(rep(" ", 25), collapse = " "),
    `Adjusted HR (95% CI)` = sprintf("%.2f (%.2f to %.2f)", exp_coef, lci, uci),
    `Adjusted HR (95% CI)` = case_when(
      row == 2 ~ "Reference",
      row == 1 | row == 7 | row == 9 ~ "",
      TRUE ~ `Adjusted HR (95% CI)`)
    ) |>
  dplyr::select(
    Variable, Categories, exp_coef, lci, uci, ` `, `Adjusted HR (95% CI)`, `Pr(>|z|)`, row
  )

coef_all

table <- 
  rbind(hc_cat_table, hc_table, mss_table) |>
  as_tibble() |>
  mutate(
    row = c(2:6, 8, 10)
  ) %>%
  add_row(
    row = c(1, 7, 9)
  ) %>%
  arrange(row)
table

data_all <- 
  coef_all |>
  left_join(table, by = "row") |>
  mutate(
    total = as.character(total), 
    total = case_when(
      row == 1 | row == 7 | row == 9 ~ "",
      TRUE ~ total
    ),
    case = as.character(case),
    case = case_when(
      row == 1 | row == 7 | row == 9 ~ "",
      TRUE ~ case
    ) 
  ) |>
  rename(
    Total = total,
    Events = case
  ) |>
  dplyr::select(
    Variable, Categories, Total, Events, ` `, `Adjusted HR (95% CI)`, exp_coef, lci, uci, `Pr(>|z|)` 
  )
data_all

p_hc_mss_all <- 
  forestploter::forest(
  data_all[, c(1:6)],
  est = data_all$exp_coef,
  lower = data_all$lci, 
  upper = data_all$uci, 
  ci_column = 5, 
  ref_line = 1,
  x_trans = "log",
  xlim = c(1, 9), 
  ticks_at = c(1, 3, 6, 9)
  )
```

## Panel B  

```{r analysis suppl figure 6 b}
# Heteroplasmy count in categories
hc_cat <- 
  survival::coxph(surv_chip_het ~ count_het_cat + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb_chip_het) 
summary(hc_cat)

hc_cat_table <- 
  table(ukb_chip_het$count_het_cat, ukb_chip_het$cancer_dx_blood_mn, useNA = "ifany") |>
  unclass() |>
  as.data.frame() |>
  rename(
    control = `0`,
    case = `1` 
  ) |>
  mutate(
    total = control + case
  )
hc_cat_table

coef_hc_cat <- summary(hc_cat)$coef[1:3, c(1:3, 5)]
coef_hc_cat

# Heteroplasmy count as continuous
hc <- 
  survival::coxph(surv_chip_het ~ count_het + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb_chip_het) 
summary(hc)

hc_table <- 
  table(ukb_chip_het$cancer_dx_blood_mn, useNA = "ifany") |>
  as.data.frame() |> 
  spread(Var1, Freq) |>
  rename(
    control = `0`, 
    case = `1`
  ) |>
  mutate(
    total = control + case
  )
hc_table 

coef_hc <- summary(hc)$coef[1, c(1:3, 5)]
coef_hc

# mMSS
mss <- 
  survival::coxph(surv_chip_het ~ mMSS + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb_chip_het) 
summary(mss)

mss_table <- 
  table(ukb_chip_het$cancer_dx_blood_mn, useNA = "ifany") |>
  as.data.frame() |> 
  spread(Var1, Freq) |>
  rename(
    control = `0`, 
    case = `1`
  ) |>
  mutate(
    total = control + case
  )
mss_table  

coef_mss <- summary(mss)$coef[1, c(1:3, 5)]
coef_mss

coef <- 
  rbind(coef_hc_cat, coef_hc, coef_mss) |>
  as_tibble() |>
  mutate(
    var = c("hc2", "hc3", "hc4", "hc", "mss")
  ) |>
  rename(
    exp_coef = `exp(coef)`,
    se_coef = `se(coef)`
  ) |>
  dplyr::select(var, everything())
coef

# data transformation for forest plot   
coef_all <- coef |>
  # add additional rows for categorical variables (1 for group name, 1 for reference) and 1 additional row for continuous variable (1 for group name)
  mutate(
    row = c(3:5, 7, 9)
  ) |>
  add_row(
    row = c(1:2, 6, 8)
  ) |>
  arrange(row) |>
  # add a column for group and category  
  mutate(
    Variable = 
      c("Heteroplasmy count", "", "", "", "", "Heteroplasmy count", "", "mMSS", ""),
    Categories = 
      c("", "1", "2", "3", "4+", "", "Continuous", "", "Continuous")
  )  %>%
  # tidy the estimates  
  mutate(
    lci =
      ifelse(row == 1 | row == 2 | row == 6 | row == 8, 1, exp(coef - 1.96*se_coef)),
    uci =
      ifelse(row == 1 | row == 2 | row == 6 | row == 8, 1, exp(coef + 1.96*se_coef)),
    ` ` = paste(rep(" ", 25), collapse = " "),
    `Adjusted HR (95% CI)` = sprintf("%.2f (%.2f to %.2f)", exp_coef, lci, uci),
    `Adjusted HR (95% CI)` = case_when(
      row == 2 ~ "Reference",
      row == 1 | row == 6 | row == 8 ~ "",
      TRUE ~ `Adjusted HR (95% CI)`)
    ) |>
  dplyr::select(
    Variable, Categories, exp_coef, lci, uci, ` `, `Adjusted HR (95% CI)`, `Pr(>|z|)`, row
  )

coef_all

table <- 
  rbind(hc_cat_table, hc_table, mss_table) |>
  as_tibble() |>
  mutate(
    row = c(2:5, 7, 9)
  ) %>%
  add_row(
    row = c(1, 6, 8)
  ) %>%
  arrange(row)
table

data_het <- 
  coef_all |>
  left_join(table, by = "row") |>
  mutate(
    total = as.character(total), 
    total = case_when(
      row == 1 | row == 6 | row == 8 ~ "",
      TRUE ~ total
    ),
    case = as.character(case),
    case = case_when(
      row == 1 | row == 6 | row == 8 ~ "",
      TRUE ~ case
    ) 
  ) |>
  rename(
    Total = total,
    Events = case
  ) |>
  dplyr::select(
    Variable, Categories, Total, Events, ` `, `Adjusted HR (95% CI)`, exp_coef, lci, uci, `Pr(>|z|)` 
  )
data_het

p_hc_mss_het <- 
  forestploter::forest(
  data_het[, c(1:6)],
  est = data_het$exp_coef,
  lower = data_het$lci, 
  upper = data_het$uci, 
  ci_column = 5, 
  ref_line = 1,
  x_trans = "log",
  xlim = c(1, 9), 
  ticks_at = c(1, 3, 6, 9)
  )
```

## Combined  

```{r analysis suppl figure 6, fig.height = 7, fig.width = 10}
combined <- ggpubr::ggarrange(p_hc_mss_all, p_hc_mss_het, labels = c("A", "B"), nrow = 2, ncol = 1, align = "v")
combined

data <-
  data_all |>
  bind_rows(data_het) |>
  add_row(.before = 1) |>
  add_row(.before = 12) |>
  mutate(
    Panel = c("A", "", "", "", "", "", "", "", "", "", "", "B", "", "", "", "", "", "", "", "", "")
  ) |>
  dplyr::select(Panel, everything())

# Write the data to the sheets
openxlsx::writeData(wb, sheet = "Supplementary Figure 6", x = data)

# data |> 
#   openxlsx::write.xlsx("ukb_mthet_chip_source_data_file.xlsx", sheetName = "Supplementary Figure 6", append = TRUE)
```

# Supplementary Figure 7 - Hazard ratios (95% confidence intervals) for the association between heteroplasmy and incident MN in individuals without CHIP.  
## Panel A  

```{r analysis suppl figure 7 a}
# Heteroplasmy count in categories
hc_cat <- 
  survival::coxph(surv_nochip ~ count_het_cat + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb_nochip) 
summary(hc_cat)

hc_cat_table <- 
  table(ukb_nochip$count_het_cat, ukb_nochip$cancer_dx_blood_mn, useNA = "ifany") |>
  unclass() |>
  as.data.frame() |>
  rename(
    control = `0`,
    case = `1` 
  ) |>
  mutate(
    total = control + case
  )
hc_cat_table

coef_hc_cat <- summary(hc_cat)$coef[1:4, c(1:3, 5)]
coef_hc_cat

# Heteroplasmy count as continuous
hc <- 
  survival::coxph(surv_nochip ~ count_het + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb_nochip) 
summary(hc)

hc_table <- 
  table(ukb_nochip$cancer_dx_blood_mn, useNA = "ifany") |>
  as.data.frame() |> 
  spread(Var1, Freq) |>
  rename(
    control = `0`, 
    case = `1`
  ) |>
  mutate(
    total = control + case
  )
hc_table 

coef_hc <- summary(hc)$coef[1, c(1:3, 5)]
coef_hc

# mMSS
mss <- 
  survival::coxph(surv_nochip ~ mMSS + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb_nochip) 
summary(mss)

mss_table <- 
  table(ukb_nochip$cancer_dx_blood_mn, useNA = "ifany") |>
  as.data.frame() |> 
  spread(Var1, Freq) |>
  rename(
    control = `0`, 
    case = `1`
  ) |>
  mutate(
    total = control + case
  )
mss_table  

coef_mss <- summary(mss)$coef[1, c(1:3, 5)]
coef_mss

coef <- 
  rbind(coef_hc_cat, coef_hc, coef_mss) |>
  as_tibble() |>
  mutate(
    var = c("hc1", "hc2", "hc3", "hc4", "hc", "mss")
  ) |>
  rename(
    exp_coef = `exp(coef)`,
    se_coef = `se(coef)`
  ) |>
  dplyr::select(var, everything())
coef

# data transformation for forest plot   
coef_all <- coef |>
  # add additional rows for categorical variables (1 for group name, 1 for reference) and 1 additional row for continuous variable (1 for group name)
  mutate(
    row = c(3:6, 8, 10)
  ) |>
  add_row(
    row = c(1:2, 7, 9)
  ) |>
  arrange(row) |>
  # add a column for group and category  
  mutate(
    Variable = 
      c("Heteroplasmy count", "", "", "", "", "", "Heteroplasmy count", "", "mMSS", ""),
    Categories = 
      c("", "0", "1", "2", "3", "4+", "", "Continuous", "", "Continuous")
  )  %>%
  # tidy the estimates  
  mutate(
    lci =
      ifelse(row == 1 | row == 2 | row == 7 | row == 9, 1, exp(coef - 1.96*se_coef)),
    uci =
      ifelse(row == 1 | row == 2 | row == 7 | row == 9, 1, exp(coef + 1.96*se_coef)),
    ` ` = paste(rep(" ", 25), collapse = " "),
    `Adjusted HR (95% CI)` = sprintf("%.2f (%.2f to %.2f)", exp_coef, lci, uci),
    `Adjusted HR (95% CI)` = case_when(
      row == 2 ~ "Reference",
      row == 1 | row == 7 | row == 9 ~ "",
      TRUE ~ `Adjusted HR (95% CI)`)
    ) |>
  dplyr::select(
    Variable, Categories, exp_coef, lci, uci, ` `, `Adjusted HR (95% CI)`, `Pr(>|z|)`, row
  )

coef_all

table <- 
  rbind(hc_cat_table, hc_table, mss_table) |>
  as_tibble() |>
  mutate(
    row = c(2:6, 8, 10)
  ) %>%
  add_row(
    row = c(1, 7, 9)
  ) %>%
  arrange(row)
table

data_all <- 
  coef_all |>
  left_join(table, by = "row") |>
  mutate(
    total = as.character(total), 
    total = case_when(
      row == 1 | row == 7 | row == 9 ~ "",
      TRUE ~ total
    ),
    case = as.character(case),
    case = case_when(
      row == 1 | row == 7 | row == 9 ~ "",
      TRUE ~ case
    ) 
  ) |>
  rename(
    Total = total,
    Events = case
  ) |>
  dplyr::select(
    Variable, Categories, Total, Events, ` `, `Adjusted HR (95% CI)`, exp_coef, lci, uci, `Pr(>|z|)` 
  )
data_all

p_hc_mss_all <- 
  forestploter::forest(
  data_all[, c(1:6)],
  est = data_all$exp_coef,
  lower = data_all$lci, 
  upper = data_all$uci, 
  ci_column = 5, 
  ref_line = 1,
  x_trans = "log",
  xlim = c(1, 9), 
  ticks_at = c(1, 3, 6, 9)
  )
```

## Panel B  

```{r analysis suppl figure 7 b}
# Heteroplasmy count in categories
hc_cat <- 
  survival::coxph(surv_nochip_het ~ count_het_cat + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb_nochip_het) 
summary(hc_cat)

hc_cat_table <- 
  table(ukb_nochip_het$count_het_cat, ukb_nochip_het$cancer_dx_blood_mn, useNA = "ifany") |>
  unclass() |>
  as.data.frame() |>
  rename(
    control = `0`,
    case = `1` 
  ) |>
  mutate(
    total = control + case
  )
hc_cat_table

coef_hc_cat <- summary(hc_cat)$coef[1:3, c(1:3, 5)]
coef_hc_cat

# Heteroplasmy count as continuous
hc <- 
  survival::coxph(surv_nochip_het ~ count_het + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb_nochip_het) 
summary(hc)

hc_table <- 
  table(ukb_nochip_het$cancer_dx_blood_mn, useNA = "ifany") |>
  as.data.frame() |> 
  spread(Var1, Freq) |>
  rename(
    control = `0`, 
    case = `1`
  ) |>
  mutate(
    total = control + case
  )
hc_table 

coef_hc <- summary(hc)$coef[1, c(1:3, 5)]
coef_hc

# mMSS
mss <- 
  survival::coxph(surv_nochip_het ~ mMSS + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb_nochip_het) 
summary(mss)

mss_table <- 
  table(ukb_nochip_het$cancer_dx_blood_mn, useNA = "ifany") |>
  as.data.frame() |> 
  spread(Var1, Freq) |>
  rename(
    control = `0`, 
    case = `1`
  ) |>
  mutate(
    total = control + case
  )
mss_table  

coef_mss <- summary(mss)$coef[1, c(1:3, 5)]
coef_mss

coef <- 
  rbind(coef_hc_cat, coef_hc, coef_mss) |>
  as_tibble() |>
  mutate(
    var = c("hc2", "hc3", "hc4", "hc", "mss")
  ) |>
  rename(
    exp_coef = `exp(coef)`,
    se_coef = `se(coef)`
  ) |>
  dplyr::select(var, everything())
coef

# data transformation for forest plot   
coef_all <- coef |>
  # add additional rows for categorical variables (1 for group name, 1 for reference) and 1 additional row for continuous variable (1 for group name)
  mutate(
    row = c(3:5, 7, 9)
  ) |>
  add_row(
    row = c(1:2, 6, 8)
  ) |>
  arrange(row) |>
  # add a column for group and category  
  mutate(
    Variable = 
      c("Heteroplasmy count", "", "", "", "", "Heteroplasmy count", "", "mMSS", ""),
    Categories = 
      c("", "1", "2", "3", "4+", "", "Continuous", "", "Continuous")
  )  %>%
  # tidy the estimates  
  mutate(
    lci =
      ifelse(row == 1 | row == 2 | row == 6 | row == 8, 1, exp(coef - 1.96*se_coef)),
    uci =
      ifelse(row == 1 | row == 2 | row == 6 | row == 8, 1, exp(coef + 1.96*se_coef)),
    ` ` = paste(rep(" ", 25), collapse = " "),
    `Adjusted HR (95% CI)` = sprintf("%.2f (%.2f to %.2f)", exp_coef, lci, uci),
    `Adjusted HR (95% CI)` = case_when(
      row == 2 ~ "Reference",
      row == 1 | row == 6 | row == 8 ~ "",
      TRUE ~ `Adjusted HR (95% CI)`)
    ) |>
  dplyr::select(
    Variable, Categories, exp_coef, lci, uci, ` `, `Adjusted HR (95% CI)`, `Pr(>|z|)`, row
  )

coef_all

table <- 
  rbind(hc_cat_table, hc_table, mss_table) |>
  as_tibble() |>
  mutate(
    row = c(2:5, 7, 9)
  ) %>%
  add_row(
    row = c(1, 6, 8)
  ) %>%
  arrange(row)
table

data_het <- 
  coef_all |>
  left_join(table, by = "row") |>
  mutate(
    total = as.character(total), 
    total = case_when(
      row == 1 | row == 6 | row == 8 ~ "",
      TRUE ~ total
    ),
    case = as.character(case),
    case = case_when(
      row == 1 | row == 6 | row == 8 ~ "",
      TRUE ~ case
    ) 
  ) |>
  rename(
    Total = total,
    Events = case
  ) |>
  dplyr::select(
    Variable, Categories, Total, Events, ` `, `Adjusted HR (95% CI)`, exp_coef, lci, uci, `Pr(>|z|)` 
  )
data_het

p_hc_mss_het <- 
  forestploter::forest(
  data_het[, c(1:6)],
  est = data_het$exp_coef,
  lower = data_het$lci, 
  upper = data_het$uci, 
  ci_column = 5, 
  ref_line = 1,
  x_trans = "log",
  xlim = c(1, 9), 
  ticks_at = c(1, 3, 6, 9)
  )
```

## Combined  

```{r analysis suppl figure 7, fig.height = 7, fig.width = 10}
combined <- ggpubr::ggarrange(p_hc_mss_all, p_hc_mss_het, labels = c("A", "B"), nrow = 2, ncol = 1, align = "v")
combined

data <-
  data_all |>
  bind_rows(data_het) |>
  add_row(.before = 1) |>
  add_row(.before = 12) |>
  mutate(
    Panel = c("A", "", "", "", "", "", "", "", "", "", "", "B", "", "", "", "", "", "", "", "", "")
  ) |>
  dplyr::select(Panel, everything())

# Write the data to the sheets
openxlsx::writeData(wb, sheet = "Supplementary Figure 7", x = data)

# data |> 
#   openxlsx::write.xlsx("ukb_mthet_chip_source_data_file.xlsx", sheetName = "Supplementary Figure 7", append = TRUE)
```

# Supplementary Figure 8 - Hazard ratios (95% confidence intervals) for the association between heteroplasmy and incident MN by mtDNA complex / region.  

## Panel A  

```{r analysis suppl figure 8 a}
hc_complex <- 
  survival::coxph(surv ~ hetcount_complex_I + hetcount_complex_III + hetcount_complex_IV + hetcount_complex_V + 
  hetcount_complex_DLOOP + hetcount_complex_RRNA + hetcount_complex_TRNA + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb)
summary(hc_complex)

hc <- summary(hc_complex)$coefficients[1:7, c(1:3, 5)] |>
  as.data.frame() |>
  rownames_to_column("Complex") |> 
  mutate(
    Complex = case_when(
      grepl("hetcount_complex_V", Complex) ~ "Complex V",
      grepl("hetcount_complex_IV", Complex) ~ "Complex IV",
      grepl("hetcount_complex_III", Complex) ~ "Complex III",
      grepl("hetcount_complex_I", Complex) ~ "Complex I", 
      grepl("DLOOP", Complex) ~ "D-loop", 
      grepl("RRNA", Complex) ~ "rRNA", 
      grepl("TRNA", Complex) ~ "tRNA"
    )
  ) 

hc

p_hc_complex <- ggforestplot::forestplot(
  df = hc, 
  name = Complex, 
  estimate = coef, 
  se = `se(coef)`,
  logodds = TRUE,
  xlab = "Hazard ratios (95% CI)", 
  title = "Heteroplasmy count"
) 
```

## Panel B  

```{r analysis suppl figure 8 b}
mss_complex <- 
  survival::coxph(surv ~ mMSS_complex_I + mMSS_complex_III + mMSS_complex_IV + mMSS_complex_V + 
  mMSS_complex_DLOOP + mMSS_complex_RRNA + mMSS_complex_TRNA + rms::rcs(age, 5) + sex + smk_ever + prev_cancer_yn, data = ukb)
summary(mss_complex)

mss <- summary(mss_complex)$coefficients[1:7, c(1:3, 5)] |>
  as.data.frame() |>
  rownames_to_column("Complex") |> 
  mutate(
    Complex = case_when(
      grepl("mMSS_complex_V", Complex) ~ "Complex V",
      grepl("mMSS_complex_IV", Complex) ~ "Complex IV",
      grepl("mMSS_complex_III", Complex) ~ "Complex III",
      grepl("mMSS_complex_I", Complex) ~ "Complex I", 
      grepl("DLOOP", Complex) ~ "D-loop", 
      grepl("RRNA", Complex) ~ "rRNA", 
      grepl("TRNA", Complex) ~ "tRNA"
    )
  ) 

mss

p_mss_complex <- ggforestplot::forestplot(
  df = mss, 
  name = Complex, 
  estimate = coef, 
  se = `se(coef)`,
  logodds = TRUE,
  xlab = "Hazard ratios (95% CI)", 
  title = "mMSS"
) 
```

## Combined  

```{r analysis suppl figure 8, fig.height = 5, fig.width = 10}
combined <- ggpubr::ggarrange(p_hc_complex, p_mss_complex, nrow = 1, labels = c("A", "B"), widths = c(1, 1))
combined

data <-
  hc |>
  bind_rows(mss)|>
  add_row(.before = 1) |>
  add_row(.before = 9) |>
  mutate(
    Panel = c("A", "", "", "", "", "", "", "", "B", "", "", "", "", "", "", ""),
    Metric = c("Heteroplasmy count", "", "", "", "", "", "", "", "mMSS", "", "", "", "", "", "", "")
  ) |>
  dplyr::select(Panel, Metric, everything())

# Write the data to the sheets
openxlsx::writeData(wb, sheet = "Supplementary Figure 8", x = data)

# Export the file
openxlsx::saveWorkbook(wb, "ukb_mthet_chip_source_data_file_02_survival.xlsx", overwrite = TRUE)

# data |> 
#   openxlsx::write.xlsx("ukb_mthet_chip_source_data_file.xlsx", sheetName = "Supplementary Figure 8", append = TRUE)
```

# Supplementary Figure 10 - Cumulative incidence and hazard ratios (95% confidence intervals) of MN by CHRS category.  

```{r analysis suppl figure 10, fig.height = 5, fig.width = 8}
km <- survfit(surv_chip ~ chrs_cat, data = ukb_chip)

plot_chip <- survminer::ggsurvplot(
  km, 
  censor = FALSE,
  risk.table = TRUE, 
  risk.table.y.text = F, 
  risk.table.y.text.col = T,
  risk.table.title = "",
  fontsize = 4,
  risk.table.height = 0.3,
  tables.theme = theme_cleantable(), 
  fun = "event", 
  xlim = c(0, 15), 
  ylim = c(0, 0.60),
  break.time.by = 5, 
  surv.scale = "percent", 
  legend.title = "", 
  font.legend = c(10, "black"), 
  legend = c(0.25, 0.85), 
  legend.lab = 
    c("Low-risk: Reference", 
      "Intermediate-risk: HR 10.6 (95% CI 8.6-13.0)", 
      "High-risk: HR 99.1 (95% CI 76.6-128.3)"),
  xlab = "Time since study enrollment (years)",
  ylab = "Cumulative incidence",
  palette = c("#00A087FF", "#4DBBD5FF", "#E64835FF")
 ) 
plot_chip

survival::coxph(surv_chip ~ chrs_cat + sex + smk_ever + prev_cancer_yn, data = ukb_chip) |>
  summary()
```


